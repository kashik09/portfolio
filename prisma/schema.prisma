generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String                   @id @default(cuid())
  email                   String                   @unique
  emailVerified           DateTime?
  name                    String?
  image                   String?
  role                    Role                     @default(USER)
  theme                   Theme                    @default(SYSTEM)
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  accountLockedAt         DateTime?
  accountLockedReason     String?
  accountStatus           AccountStatus            @default(ACTIVE)
  birthDate               DateTime?
  guardianEmail           String?
  isMinor                 Boolean                  @default(false)
  membershipId            String?
  twoFactorEnabled        Boolean                  @default(false)
  twoFactorSecret         String?
  password                String?
  backupCodes             Json?
  twoFactorVerified       Boolean                  @default(false)
  accounts                Account[]
  auditLogs               AuditLog[]
  cart                    Cart?
  creditTransactions      CreditTransaction[]
  digitalProductPurchases DigitalProductPurchase[]
  downloads               Download[]
  licenses                License[]
  orders                  Order[]
  projectRequests         ProjectRequest[]
  serviceProjects         ServiceProject[]
  sessions                Session[]
  adConsent               UserAdConsent?
  membership              Membership?              @relation(fields: [membershipId], references: [id])
  wishlistItems           WishlistItem[]

  @@index([email])
  @@index([accountStatus])
  @@index([membershipId])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model ProjectRequest {
  id           String        @id @default(cuid())
  userId       String?
  name         String
  email        String
  phone        String?
  company      String?
  description  String
  requirements String?
  attachments  String[]
  status       RequestStatus @default(PENDING)
  priority     Priority      @default(MEDIUM)
  adminNotes   String?
  assignedTo   String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  respondedAt  DateTime?
  projectType  String
  budget       String
  timeline     String
  user         User?         @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([email])
  @@index([status])
  @@index([createdAt])
  @@index([projectType])
  @@map("project_requests")
}

model Project {
  id           String          @id @default(cuid())
  slug         String          @unique
  title        String
  description  String
  category     ProjectCategory
  tags         String[]
  techStack    String[]
  features     String[]
  images       String[]
  thumbnail    String?
  githubUrl    String?
  liveUrl      String?
  demoUrl      String?
  caseStudyUrl String?
  content      String?
  featured     Boolean         @default(false)
  viewCount    Int             @default(0)
  likeCount    Int             @default(0)
  published    Boolean         @default(false)
  publishedAt  DateTime?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  problem      String?

  @@index([slug])
  @@index([category])
  @@index([featured])
  @@index([published])
  @@index([createdAt])
  @@map("projects")
}

model Visit {
  id          String   @id @default(cuid())
  pagePath    String
  pageTitle   String?
  visitorId   String
  referrer    String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  userAgent   String?
  device      String?
  browser     String?
  os          String?
  country     String?
  city        String?
  sessionId   String?
  duration    Int?
  metadata    Json?
  timestamp   DateTime @default(now())

  @@index([pagePath])
  @@index([visitorId])
  @@index([timestamp])
  @@index([sessionId])
  @@map("visits")
}

model AnalyticsEvent {
  id        String   @id @default(cuid())
  action    String
  page      String?
  category  String?
  label     String?
  value     Int?
  device    String?
  referrer  String?
  data      Json?
  createdAt DateTime @default(now())

  @@index([action])
  @@index([page])
  @@index([createdAt])
  @@index([action, createdAt])
  @@index([page, createdAt])
  @@map("analytics_events")
}

model DigitalProduct {
  id                String                   @id @default(cuid())
  name              String
  slug              String                   @unique
  description       String
  category          ProductCategory
  tags              String[]
  price             Decimal                  @db.Decimal(10, 2)
  currency          String                   @default("USD")
  fileUrl           String
  fileSize          Int
  fileType          String
  thumbnailUrl      String?
  previewImages     String[]
  personalLicense   Boolean                  @default(true)
  commercialLicense Boolean                  @default(true)
  teamLicense       Boolean                  @default(false)
  version           String                   @default("1.0.0")
  changelog         String?
  documentation     String?
  published         Boolean                  @default(false)
  publishedAt       DateTime?
  featured          Boolean                  @default(false)
  downloadCount     Int                      @default(0)
  purchaseCount     Int                      @default(0)
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
  creditPrice       Int?
  ugxPrice          Decimal?                 @db.Decimal(10, 2)
  usdPrice          Decimal?                 @db.Decimal(10, 2)
  cartItems         CartItem[]
  purchases         DigitalProductPurchase[]
  downloads         Download[]
  licenses          License[]
  orderItems        OrderItem[]
  wishlistItems     WishlistItem[]

  @@index([slug])
  @@index([category])
  @@index([published])
  @@index([featured])
  @@map("digital_products")
}

model WishlistItem {
  id        String         @id @default(cuid())
  userId    String
  productId String
  createdAt DateTime       @default(now())
  product   DigitalProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
  @@map("wishlist_items")
}

model DigitalProductPurchase {
  id            String         @id @default(cuid())
  userId        String
  productId     String
  licenseType   LicenseType
  price         Decimal        @db.Decimal(10, 2)
  currency      String
  paymentStatus PaymentStatus  @default(PENDING)
  paymentMethod String?
  transactionId String?        @unique
  purchasedAt   DateTime       @default(now())
  product       DigitalProduct @relation(fields: [productId], references: [id])
  user          User           @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([productId])
  @@index([paymentStatus])
  @@map("digital_product_purchases")
}

model License {
  id              String                  @id @default(cuid())
  userId          String
  productId       String
  licenseKey      String                  @unique
  licenseType     LicenseType
  status          LicenseStatus           @default(ACTIVE)
  maxUsers        Int                     @default(1)
  currentUsers    Int                     @default(0)
  abuseDetected   Boolean                 @default(false)
  abuseReason     String?
  revokedAt       DateTime?
  revokedReason   String?
  issuedAt        DateTime                @default(now())
  expiresAt       DateTime?
  abuseFlagged    Boolean                 @default(false)
  abuseFlaggedAt  DateTime?
  abuseFlaggedBy  String?
  downloads       Download[]
  seatAssignments LicenseSeatAssignment[]
  product         DigitalProduct          @relation(fields: [productId], references: [id])
  user            User                    @relation(fields: [userId], references: [id])
  orderItem       OrderItem?

  @@index([userId])
  @@index([productId])
  @@index([licenseKey])
  @@index([status])
  @@index([abuseFlagged])
  @@map("licenses")
}

model LicenseSeatAssignment {
  id                String    @id @default(cuid())
  licenseId         String
  assignedUserId    String
  assignedUserEmail String
  assignedBy        String
  assignedAt        DateTime  @default(now())
  revokedAt         DateTime?
  revokedBy         String?
  active            Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  license           License   @relation(fields: [licenseId], references: [id], onDelete: Cascade)

  @@unique([licenseId, assignedUserEmail])
  @@index([licenseId])
  @@index([assignedUserId])
  @@index([active])
  @@map("license_seat_assignments")
}

model Download {
  id                String         @id @default(cuid())
  userId            String
  productId         String
  licenseId         String
  successful        Boolean        @default(false)
  ipHash            String
  deviceFingerprint String?
  userAgent         String?
  downloadedAt      DateTime       @default(now())
  license           License        @relation(fields: [licenseId], references: [id])
  product           DigitalProduct @relation(fields: [productId], references: [id])
  user              User           @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([productId])
  @@index([licenseId])
  @@index([downloadedAt])
  @@map("downloads")
}

model DownloadResetRequest {
  id          String             @id @default(cuid())
  userId      String
  productId   String
  reason      String
  status      ResetRequestStatus @default(PENDING)
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNotes String?
  createdAt   DateTime           @default(now())

  @@index([userId])
  @@index([status])
  @@map("download_reset_requests")
}

model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  items     CartItem[]
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("carts")
}

model CartItem {
  id          String         @id @default(cuid())
  cartId      String
  productId   String
  licenseType LicenseType
  quantity    Int            @default(1)
  createdAt   DateTime       @default(now())
  cart        Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product     DigitalProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId, licenseType])
  @@index([cartId])
  @@index([productId])
  @@map("cart_items")
}

model Order {
  id              String            @id @default(cuid())
  orderNumber     String            @unique
  userId          String
  subtotal        Decimal           @db.Decimal(10, 2)
  tax             Decimal           @default(0) @db.Decimal(10, 2)
  total           Decimal           @db.Decimal(10, 2)
  currency        String            @default("USD")
  paymentStatus   PaymentStatus     @default(PENDING)
  paymentMethod   String?
  paymentProvider String?
  transactionId   String?
  purchaseType    OrderPurchaseType
  creditsUsed     Int?
  membershipId    String?
  status          OrderStatus       @default(PENDING)
  fulfilledAt     DateTime?
  termsAccepted   Boolean           @default(false)
  termsVersion    String?
  customerEmail   String
  customerName    String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  items           OrderItem[]
  membership      Membership?       @relation(fields: [membershipId], references: [id])
  user            User              @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([orderNumber])
  @@index([paymentStatus])
  @@index([status])
  @@map("orders")
}

model OrderItem {
  id          String         @id @default(cuid())
  orderId     String
  productId   String
  productName String
  productSlug String
  licenseType LicenseType
  price       Decimal        @db.Decimal(10, 2)
  currency    String
  licenseId   String?        @unique
  createdAt   DateTime       @default(now())
  license     License?       @relation(fields: [licenseId], references: [id])
  order       Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     DigitalProduct @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model ServiceProject {
  id                 String                @id @default(cuid())
  userId             String
  name               String
  description        String
  category           ServiceCategory
  currentPhase       ProjectPhase          @default(DESIGN)
  designRevisions    Int                   @default(0)
  designRevisionsMax Int                   @default(2)
  buildRevisions     Int                   @default(0)
  buildRevisionsMax  Int                   @default(1)
  approvedFeatures   String[]
  scope              String?
  startDate          DateTime?
  deadline           DateTime?
  isPaused           Boolean               @default(false)
  pauseReason        String?
  pausedAt           DateTime?
  status             ServiceStatus         @default(ACTIVE)
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  completedAt        DateTime?
  phases             ProjectPhaseHistory[]
  addOns             ServiceAddOn[]
  user               User                  @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([currentPhase])
  @@index([status])
  @@map("service_projects")
}

model ProjectPhaseHistory {
  id          String         @id @default(cuid())
  projectId   String
  phase       ProjectPhase
  startedAt   DateTime       @default(now())
  completedAt DateTime?
  notes       String?
  project     ServiceProject @relation(fields: [projectId], references: [id])

  @@index([projectId])
  @@map("project_phase_history")
}

model ServiceAddOn {
  id          String         @id @default(cuid())
  projectId   String
  type        AddOnType
  description String
  creditCost  Int
  status      AddOnStatus    @default(PENDING)
  requestedAt DateTime       @default(now())
  approvedAt  DateTime?
  completedAt DateTime?
  project     ServiceProject @relation(fields: [projectId], references: [id])

  @@index([projectId])
  @@index([status])
  @@map("service_add_ons")
}

model Membership {
  id               String              @id @default(cuid())
  tier             MembershipTier
  totalCredits     Int
  usedCredits      Int                 @default(0)
  remainingCredits Int
  rolloverCredits  Int                 @default(0)
  rolloverCap      Int
  startDate        DateTime            @default(now())
  endDate          DateTime
  renewalDate      DateTime?
  autoRenew        Boolean             @default(false)
  status           MembershipStatus    @default(ACTIVE)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  transactions     CreditTransaction[]
  orders           Order[]
  users            User[]

  @@index([status])
  @@map("memberships")
}

model CreditTransaction {
  id           String                @id @default(cuid())
  userId       String
  membershipId String
  type         CreditTransactionType
  amount       Int
  balance      Int
  description  String
  reference    String?
  createdAt    DateTime              @default(now())
  membership   Membership            @relation(fields: [membershipId], references: [id])
  user         User                  @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([membershipId])
  @@index([createdAt])
  @@map("credit_transactions")
}

model AuditLog {
  id         String      @id @default(cuid())
  userId     String?
  action     AuditAction
  resource   String
  resourceId String
  details    Json?
  ipHash     String?
  userAgent  String?
  createdAt  DateTime    @default(now())
  user       User?       @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}

model DeviceSession {
  id                String   @id @default(cuid())
  userId            String
  deviceFingerprint String
  ipHash            String
  userAgent         String?
  blocked           Boolean  @default(false)
  blockedReason     String?
  firstSeen         DateTime @default(now())
  lastSeen          DateTime @default(now())

  @@index([userId])
  @@index([blocked])
  @@map("device_sessions")
}

model ContentPage {
  id        String          @id @default(cuid())
  slug      String          @unique
  title     String
  type      ContentPageType
  content   String
  published Boolean         @default(true)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@index([slug])
  @@index([type])
  @@map("content_pages")
}

model PageContent {
  id        String   @id @default(cuid())
  slug      String   @unique
  data      Json
  version   String   @default("1.0")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@map("page_contents")
}

model SiteSettings {
  id                   String    @id @default("site_settings_singleton")
  maintenanceMode      Boolean   @default(false)
  availableForBusiness Boolean   @default(true)
  adsEnabled           Boolean   @default(false)
  adsProvider          String    @default("")
  adsClientId          String?
  adsPlacements        Json?
  updatedAt            DateTime  @updatedAt
  smtpHost             String?
  smtpPassword         String?
  smtpPort             Int?
  smtpSecure           Boolean   @default(false)
  smtpUsername         String?
  avatarUrl            String?
  availabilityMessage  String?
  availabilityStatus   String    @default("AVAILABLE")
  leaveEnd             DateTime?
  leaveStart           DateTime?
  manualOverride       Boolean   @default(false)

  @@map("site_settings")
}

model FeatureFlag {
  id          String      @id @default(cuid())
  name        String      @unique
  description String?
  enabled     Boolean     @default(false)
  environment Environment @default(PRODUCTION)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([name])
  @@index([environment])
  @@map("feature_flags")
}

model SystemBackup {
  id                String       @id @default(cuid())
  type              BackupType
  description       String?
  storageUrl        String
  size              Int
  includesDatabase  Boolean      @default(true)
  includesFiles     Boolean      @default(false)
  includesConfig    Boolean      @default(false)
  includesAuditLogs Boolean      @default(false)
  status            BackupStatus @default(PENDING)
  createdAt         DateTime     @default(now())
  completedAt       DateTime?

  @@index([status])
  @@index([createdAt])
  @@map("system_backups")
}

model UserAdConsent {
  id              String    @id @default(cuid())
  userId          String    @unique
  personalizedAds Boolean   @default(false)
  consentedAt     DateTime?
  updatedAt       DateTime  @updatedAt
  user            User      @relation(fields: [userId], references: [id])

  @@map("user_ad_consents")
}

enum Role {
  USER
  ADMIN
  MODERATOR
  VIEWER
  EDITOR
  OWNER
}

enum Theme {
  LIGHT
  DARK
  SYSTEM
}

enum ProjectType {
  WEB_APPLICATION
  MOBILE_APPLICATION
  DESKTOP_APPLICATION
  E_COMMERCE
  LANDING_PAGE
  PORTFOLIO
  CUSTOM_SOFTWARE
  API_INTEGRATION
  CONSULTING
  OTHER
}

enum BudgetRange {
  UNDER_1K
  RANGE_1K_5K
  RANGE_5K_10K
  RANGE_10K_25K
  RANGE_25K_50K
  ABOVE_50K
  NOT_SURE
}

enum Timeline {
  URGENT
  SHORT
  MEDIUM
  LONG
  FLEXIBLE
}

enum RequestStatus {
  PENDING
  REVIEWING
  IN_PROGRESS
  COMPLETED
  REJECTED
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ProjectCategory {
  WEB_DEVELOPMENT
  MOBILE_DEVELOPMENT
  UI_UX_DESIGN
  FULL_STACK
  BACKEND
  FRONTEND
  DEVOPS
  DATA_SCIENCE
  MACHINE_LEARNING
  BLOCKCHAIN
  GAME_DEVELOPMENT
  OTHER
  PERSONAL
  CLASS
}

enum AccountStatus {
  ACTIVE
  LOCKED
  BANNED
  SUSPENDED
}

enum ProductCategory {
  TEMPLATE
  THEME
  UI_KIT
  CODE_SNIPPET
  DOCUMENTATION
  ASSET
  LICENSE
  OTHER
}

enum LicenseType {
  PERSONAL
  COMMERCIAL
  TEAM
}

enum LicenseStatus {
  ACTIVE
  EXPIRED
  REVOKED
  SUSPENDED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum OrderPurchaseType {
  ONE_TIME
  CREDITS
}

enum OrderStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum ResetRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ServiceCategory {
  WEB_DESIGN
  WEB_DEVELOPMENT
  MOBILE_APP
  CUSTOM_SOFTWARE
  CONSULTING
  MAINTENANCE
}

enum ProjectPhase {
  DESIGN
  BUILD
  POST_LAUNCH
  COMPLETED
  PAUSED
}

enum ServiceStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum AddOnType {
  EXTRA_REVISION
  CONTENT_EDIT
  SUPPORT_CALL
  RUSH_DELIVERY
  EMERGENCY_FIX
  REOPEN_PROJECT
  CUSTOM
}

enum AddOnStatus {
  PENDING
  APPROVED
  IN_PROGRESS
  COMPLETED
  REJECTED
}

enum MembershipTier {
  BASIC_ACCESS
  PRO
  MANAGED
}

enum MembershipStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  PAUSED
}

enum CreditTransactionType {
  INITIAL_ALLOCATION
  RENEWAL
  TOP_UP
  USAGE
  REFUND
  ROLLOVER
  ADJUSTMENT
}

enum AuditAction {
  USER_LOGIN
  USER_LOGOUT
  LICENSE_ISSUED
  LICENSE_REVOKED
  DOWNLOAD_ATTEMPTED
  DOWNLOAD_SUCCEEDED
  DOWNLOAD_FAILED
  ABUSE_DETECTED
  ACCOUNT_LOCKED
  ACCOUNT_UNLOCKED
  CREDIT_USED
  MEMBERSHIP_CREATED
  MEMBERSHIP_RENEWED
  PROJECT_CREATED
  PROJECT_PHASE_CHANGED
  ADD_ON_REQUESTED
  SETTINGS_CHANGED
  LICENSE_SUSPENDED
  LICENSE_REACTIVATED
  LICENSE_SEAT_ASSIGNED
  LICENSE_SEAT_REVOKED
  LICENSE_ABUSE_FLAGGED
  LICENSE_ABUSE_CLEARED
  DOWNLOAD_ABUSE_DETECTED
  DOWNLOAD_RESET_REQUESTED
  DOWNLOAD_RESET_APPROVED
  DOWNLOAD_RESET_REJECTED
  CREDIT_ADJUSTED
  MEMBERSHIP_SUSPENDED
  FEATURE_FLAG_TOGGLED
}

enum Environment {
  DEVELOPMENT
  STAGING
  PRODUCTION
}

enum BackupType {
  SCHEDULED
  MANUAL
  PRE_DEPLOYMENT
}

enum BackupStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum ContentPageType {
  TERMS
  PRIVACY_POLICY
  ABOUT
  OTHER
}
